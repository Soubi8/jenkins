pipeline {
    agent {
        label 'agent1'
    }
    environment {
        DOCKER_PWD = credentials('docker-pwd')
        IP_DEV = '3.126.59.30'
        IP_PROD = '3.73.49.83'
    }
    stages {
        stage('SCM Checkout') {
            steps {
                git credentialsId: 'jenkins_key', url: 'git@github.com:Soubi8/realworld-springboot-java.git'
                script {
                    TAG = sh(returnStdout: true, script: 'git rev-parse --abbrev-ref HEAD').trim()
                }
            }
        }
        stage('Build App to Docker Image') {
            steps {
                sh """
                    sudo usermod -aG docker $USER
                    sudo chown $USER /var/run/docker.sock
                    docker build --pull -t ${REGISTRY_NAME}:${TAG} .
                """
            }
        }
        stage('Push Docker Image') {
            steps {  // Add credential helper for future
                sh 'echo "$DOCKER_PWD" | docker login -u soubi8 --password-stdin'
                sh "docker push ${REGISTRY_NAME}:${TAG}"
                sh 'docker logout' 
            }
        }
        stage('Deploy to Dev Server') {
            steps {
                script {
                    def dockerRun = "docker run --rm -d -p 8080:8080 ${REGISTRY_NAME}:${TAG}"
                    sshagent(['aws_fp_api']) {
                        sh "ssh -o StrictHostKeyChecking=no ubuntu@${IP_DEV} ${dockerRun}"
                    }
                }
            }
        }
        stage('Test the API on Dev Server') {
            steps {
                sh """
                    bash ~/agent/workspace/${JOB_NAME}/200.sh
                    export APIURL=https://dev.epam.pp.ua && bash ~/agent/workspace/${JOB_NAME}/doc/run-api-tests.sh
                """
            }
        }
    }
}